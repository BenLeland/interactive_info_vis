<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.10/lib/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.10/lib/addons/p5.sound.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>Tabbed p5 sketches</title>
</head>

<body>
  <main>
    <nav class="tabs" role="tablist" aria-label="Main tabs">
      <button type="button" class="tab-btn active" data-target="tab1" data-sketch="sk1" role="tab"
        aria-selected="true">Tab 1</button>
      <button type="button" class="tab-btn" data-target="tab2" data-sketch="sk2" role="tab">Tab 2</button>
      <button type="button" class="tab-btn" data-target="tab3" data-sketch="sk3" role="tab">Tab 3</button>
      <button type="button" class="tab-btn" data-target="tab4" data-sketch="sk4" role="tab">Tab 4</button>
      <button type="button" class="tab-btn" data-target="tab5" data-sketch="sk5" role="tab">Tab 5</button>
    </nav>

    <section id="tab1" class="tab-content active" role="tabpanel">
      <div id="sketch-container-sk1" class="sketch-container"></div>
    </section>

    <section id="tab2" class="tab-content" role="tabpanel">
      <div id="sketch-container-sk2" class="sketch-container"></div>
    </section>

    <section id="tab3" class="tab-content" role="tabpanel">
      <div id="sketch-container-sk3" class="sketch-container"></div>
    </section>

    <section id="tab4" class="tab-content" role="tabpanel">
      <div id="sketch-container-sk4" class="sketch-container"></div>
    </section>

    <section id="tab5" class="tab-content" role="tabpanel">
      <div id="sketch-container-sk5" class="sketch-container"></div>
    </section>
  </main>

  <script>
    // Global registry used by sketch files to register instance-mode factories
    window._sketchRegistry = window._sketchRegistry || {};
    window._sketchInstances = window._sketchInstances || {};
    window._sketchScriptsLoaded = window._sketchScriptsLoaded || {};

    window.registerSketch = function (id, factory) {
      window._sketchRegistry[id] = factory;
    };

    // map sketch ids to script paths
    const SKETCH_SCRIPT_BY_ID = {
      sk1: 'sketch1.js',
      sk2: 'sketch2.js',
      sk3: 'sketch3.js',
      sk4: 'sketch4.js',
      sk5: 'sketch5.js'
    };

    function loadSketchScriptIfNeeded(sketchId) {
      return new Promise((resolve, reject) => {
        if (window._sketchScriptsLoaded[sketchId]) return resolve();
        const src = SKETCH_SCRIPT_BY_ID[sketchId];
        if (!src) return reject(new Error('No script configured for ' + sketchId));
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => { window._sketchScriptsLoaded[sketchId] = true; resolve(); };
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.body.appendChild(s);
      });
    }

    function createOrShowSketch(sketchId) {
      const container = document.getElementById('sketch-container-' + sketchId);
      // hide other canvases
      Object.keys(window._sketchInstances).forEach(id => {
        const inst = window._sketchInstances[id];
        if (inst && inst.canvas) inst.canvas.style.display = (id === sketchId) ? '' : 'none';
      });

      if (window._sketchInstances[sketchId]) {
        const inst = window._sketchInstances[sketchId];
        if (inst && inst.canvas && container) container.appendChild(inst.canvas);
        if (inst && inst.canvas) inst.canvas.style.display = '';
        return;
      }

      const factory = window._sketchRegistry[sketchId];
      if (!factory) return; // sketch will register itself when its script loads

      const p5inst = new p5(factory, container);
      window._sketchInstances[sketchId] = p5inst;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const buttons = document.querySelectorAll('.tab-btn');
      const contents = document.querySelectorAll('.tab-content');

      buttons.forEach(btn => {
        btn.addEventListener('click', async () => {
          buttons.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
          contents.forEach(c => c.classList.remove('active'));

          btn.classList.add('active');
          btn.setAttribute('aria-selected', 'true');

          const target = document.getElementById(btn.dataset.target);
          if (target) target.classList.add('active');

          const sketchId = btn.dataset.sketch;
          if (sketchId) {
            try {
              await loadSketchScriptIfNeeded(sketchId);
              // if the sketch file registered a factory, create it; if not, wait a tick
              if (window._sketchRegistry[sketchId]) createOrShowSketch(sketchId);
              else setTimeout(() => { if (window._sketchRegistry[sketchId]) createOrShowSketch(sketchId); }, 50);
            } catch (err) { console.error(err); }
          } else {
            Object.values(window._sketchInstances).forEach(inst => { if (inst && inst.canvas) inst.canvas.style.display = 'none'; });
          }
        });
      });

      // kick off first tab (lazy load its sketch)
      const first = document.querySelector('.tab-btn');
      if (first) first.click();
    });
  </script>
</body>

</html>